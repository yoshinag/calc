<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>DDL to ER Diagram Viewer</title>
    <style>
        body{font-family:sans-serif;display:flex;flex-direction:column;height:100vh;margin:0;padding:10px;box-sizing:border-box;background-color:#f8f8f8;}
        h1{text-align:center;margin-top:0;color:#333;}
        .container{display:flex;flex-direction:column;flex-grow:1;gap:10px;}
        .ddl-input-area{flex:1;display:flex;flex-direction:column;border:1px solid #ccc;padding:15px;box-sizing:border-box;background-color:#fff;}
        .output-sections{flex:2;display:flex;flex-direction:column;gap:10px;}
        .dot-output-area,.diagram-output-area{flex:1;display:flex;flex-direction:column;border:1px solid #ccc;padding:15px;box-sizing:border-box;background-color:#fff;overflow:hidden;}
        label{font-weight:bold;margin-bottom:8px;color:#555;display:block;}
        textarea{flex-grow:1;font-family:monospace;font-size:.9em;resize:none;padding:10px;border:1px solid #eee;box-sizing:border-box;background-color:#f9f9f9;}
        textarea[readonly]{background-color:#eee;}
        button{margin-top:15px;padding:10px 20px;background-color:#007bff;color:white;border:none;border-radius:4px;cursor:pointer;font-size:1em;align-self:flex-start;transition:background-color .2s ease;}
        button:hover{background-color:#0056b3;}
        .diagram-content{flex-grow:1;overflow:auto;border:1px solid #eee;padding:10px;box-sizing:border-box;display:flex;justify-content:center;align-items:flex-start;background-color:#fff;}
        .error{color:red;font-weight:bold;white-space:pre-wrap;word-break:break-all;}
        .diagram-content svg{max-width:100%;height:auto;display:block;}
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/viz.js/2.1.2/viz.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/viz.js/2.1.2/full.render.js"></script>
</head>
<body>
<h1>DDL to ER Diagram Viewer</h1>
<div class="container">
    <div class="ddl-input-area">
        <label for="ddlInput">DDLをここに記述:</label>
        <textarea id="ddlInput">
-- users テーブル
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- orders テーブル
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    user_id INT NOT NULL,
    order_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    total_amount DECIMAL(10, 2) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- order_items テーブル
CREATE TABLE order_items (
    id SERIAL PRIMARY KEY,
    order_id INT NOT NULL,
    product_id INT NOT NULL,
    quantity INT NOT NULL CHECK (quantity > 0),
    price DECIMAL(10, 2) NOT NULL CHECK (price >= 0),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE
);
</textarea>
        <button onclick="processDDL()">DOT生成 & ER図描画</button>
    </div>
    <div class="output-sections">
        <div class="dot-output-area">
            <label for="dotOutput">生成されたDOT言語:</label>
            <textarea id="dotOutput" readonly></textarea>
        </div>
        <div class="diagram-output-area">
            <label>ER図:</label>
            <div id="diagramOutput" class="diagram-content">
                <p>↑にDDLを記述し、「DOT生成 & ER図描画」ボタンを押してください。</p>
            </div>
        </div>
    </div>
</div>
<script>
    function a(b){
        const c={};
        let d=b.replace(/--.*?\n/g,'\n').replace(/\/\*.*?\*\//gs,'').replace(/\s+/g,' ').trim().toUpperCase();
        const e=d.split(/;\s*CREATE TABLE\s+/);
        e.forEach((f,g)=>{
            f=f.trim();if(!f)return;
            if(g>0)f='CREATE TABLE '+f;
            if(f.endsWith(';'))f=f.substring(0,f.length-1);
            const h=f.match(/^CREATE TABLE\s+["`]?(\S+?)["`]?\s*\((.*?)\)$/);
            if(!h)return;
            const i=h[1].replace(/["`]/g,'').toLowerCase();
            let j=h[2].trim();
            const k={name:i,columns:[],foreignKeys:[]};c[i]=k;
            const l=[];let m=0,n='';
            for(let o=0;o<j.length;o++){
                const p=j[o];if(p==='(')m++;if(p===')')m--;
                if(p===','&&m===0){l.push(n.trim());n='';}else{n+=p;}
            }
            if(n.trim())l.push(n.trim());
            l.forEach(q=>{
                if(!q)return;
                const r=q.match(/^FOREIGN KEY\s*\((.*?)\)\s*REFERENCES\s+["`]?(\S+?)["`]?\s*\((.*?)\)(?:\s+ON DELETE\s+\S+)?(?:\s+ON UPDATE\s+\S+)?$/);
                if(r){
                    const s=r[1].split(',').map(t=>t.trim().replace(/["`]/g,'').toLowerCase());
                    const u=r[2].replace(/["`]/g,'').toLowerCase();
                    const v=r[3].split(',').map(t=>t.trim().replace(/["`]/g,'').toLowerCase());
                    if(s.length>0&&v.length>0){k.foreignKeys.push({sourceColumn:s[0],targetTable:u,targetColumn:v[0]});}
                    return;
                }
                const w=q.match(/^CONSTRAINT\s+\S+\s+PRIMARY KEY\s*\((.*?)\)$/);
                if(w){
                    const x=w[1].split(',').map(t=>t.trim().replace(/["`]/g,'').toLowerCase());
                    if(x.length>0){k._compositePkColumns=x;}
                    return;
                }
                const y=q.match(/^["`]?(\S+?)["`]?\s+(\S+)/);
                if(y){
                    const z=y[1].replace(/["`]/g,'').toLowerCase();
                    const A=q.substring(y[0].length).trim();
                    let B=y[2];let C=A.includes('PRIMARY KEY'),D=A.includes('NOT NULL'),E=A.includes('UNIQUE'),F=!1;
                    const G=A.match(/\s(PRIMARY|NOT NULL|UNIQUE|DEFAULT|CHECK|REFERENCES)\b/);
                    if(G){B+=' '+A.substring(0,G.index).trim();}else{B+=' '+A;}
                    B=B.trim();
                    k.columns.push({name:z,dataType:B,isPrimaryKey:C,isForeignKey:F,isNotNull:D,isUnique:E});
                }
            });
            if(k._compositePkColumns){
                k._compositePkColumns.forEach(H=>{
                    const I=k.columns.find(J=>J.name.toLowerCase()===H.toLowerCase());
                    if(I){I.isPrimaryKey=!0;}
                });delete k._compositePkColumns;
            }
            k.foreignKeys.forEach(K=>{
                const L=k.columns.find(M=>M.name.toLowerCase()===K.sourceColumn.toLowerCase());
                if(L){L.isForeignKey=!0;}
            });
        });return c;
    }
    function b(c){
        let d=`digraph ERDiagram {\n  rankdir=LR;\n  node [shape=plaintext];\n\n`;
        function e(f){if(f==null)return'';return f.replace(/&/g,"&").replace(/</g,"<").replace(/>/g,">").replace(/"/g,"\"").replace(/'/g,"'");}
        for(const f in c){
            const g=c[f];if(!g.columns||g.columns.length===0)continue;
            d+=`  ${f} [label=<\n    <TABLE BORDER="0" CELLBORDER="1" CELLSPACING="0" CELLPADDING="4">\n      <TR><TD COLSPAN="2" BGCOLOR="lightblue"><B>${f}</B></TD></TR>\n`;
            g.columns.forEach(h=>{
                let i='',j=e(h.name),k=e(h.dataType);
                if(h.isPrimaryKey&&h.isForeignKey){i='#ffcc99';j=`<B>${j}</B>`;k+=' (PK, FK)';}
                else if(h.isPrimaryKey){i='yellow';j=`<B>${j}</B>`;k+=' (PK)';}
                else if(h.isForeignKey){i='#aaffaa';j=`<B>${j}</B>`;k+=' (FK)';}
                if(!h.isPrimaryKey){if(h.isNotNull)k+=' NOT NULL';if(h.isUnique)k+=' UNIQUE';}
                d+=`      <TR><TD PORT="${h.name}" ALIGN="LEFT" ${i?`BGCOLOR="${i}"`:''}>${j}</TD><TD ALIGN="LEFT">${k}</TD></TR>\n`;
            });
            d+=`    </TABLE>\n  >];\n\n`;
        }
        for(const f in c){
            const g=c[f];
            g.foreignKeys.forEach(h=>{d+=`  "${f}":"${h.sourceColumn}" -> "${h.targetTable}":"${h.targetColumn}" [label="1..*", headlabel="1", taillabel="*"];\n`;});
        }
        d+=`}\n`;return d;
    }
    async function c(){
        const d=document.getElementById('ddlInput'),e=document.getElementById('dotOutput'),f=document.getElementById('diagramOutput');
        e.value='';f.innerHTML='<p>生成中...</p>';f.classList.remove('error');
        try{
            const g=a(d.value);
            const h=b(g);
            e.value=h;
            const viz=new Viz();
            const i=await viz.renderString(h,{format:'svg'});
            f.innerHTML=i;
        }catch(j){
            const k=`処理エラー:\n${j.message||j}`;
            f.innerHTML='<p class="error">'+e(k).replace(/\n/g,'<br>')+'</p>';
            e.value=`Error generating DOT:\n${j.message||j}`;
        }
    }
    window.onload=c;
</script>
</body>
</html>